{"version":3,"sources":["pen.js"],"names":["TurndownService","extend","destination","i","arguments","length","source","key","hasOwnProperty","repeat","character","count","Array","join","blockElements","isBlock","node","indexOf","nodeName","toLowerCase","voidElements","isVoid","voidSelector","hasVoid","querySelector","rules","paragraph","filter","replacement","content","lineBreak","options","br","heading","hLevel","Number","charAt","headingStyle","underline","blockquote","replace","list","parent","parentNode","lastElementChild","listItem","prefix","bulletListMarker","start","getAttribute","index","prototype","call","children","nextSibling","test","indentedCodeBlock","codeBlockStyle","firstChild","textContent","fencedCodeBlock","className","language","match","fence","horizontalRule","hr","inlineLink","linkStyle","href","title","referenceLink","reference","linkReferenceStyle","id","references","push","append","emphasis","trim","emDelimiter","strong","strongDelimiter","code","hasSiblings","previousSibling","isCodeBlock","delimiter","leadingSpace","trailingSpace","matches","image","alt","src","titlePart","Rules","_keep","_remove","blankRule","blankReplacement","keepReplacement","defaultRule","defaultReplacement","array","add","rule","unshift","keep","remove","forNode","isBlank","findRule","forEach","fn","filterValue","isArray","TypeError","collapseWhitespace","element","isPre","prevText","prevVoid","prev","next","nodeType","text","data","substr","nextNode","removeChild","current","root","window","canParseHTMLNatively","Parser","DOMParser","canParse","parseFromString","e","createHTMLParser","shouldUseActiveX","string","doc","ActiveXObject","designMode","open","write","close","document","implementation","createHTMLDocument","useActiveX","HTMLParser","RootNode","input","htmlParser","getElementById","cloneNode","_htmlParser","Node","isCode","flankingWhitespace","leading","trailing","hasLeading","hasTrailing","isFlankedByWhitespace","side","sibling","regExp","isFlanked","nodeValue","reduce","leadingNewLinesRegExp","trailingNewLinesRegExp","defaults","outerHTML","turndown","canConvert","output","process","postProcess","use","plugin","addRule","escape","split","self","childNodes","replacementForNode","whitespace","separatingNewlines","newlines","sort","maxNewlines","string1","string2","separator","Pen","debugMode","selection","utils","toString","Object","slice","commandsReg","block","inline","insert","wrap","lineBreakReg","effectNodeReg","strReg","whiteSpace","mailTo","http","autoLinkReg","url","notLink","maxLength","is","obj","type","iterator","arrayLike","l","copy","value","log","message","force","console","delayExec","timer","delay","clearTimeout","setTimeout","merge","config","class","debug","toolbar","stay","stayMsg","textarea","titles","cleanAttrs","cleanTags","linksInNewWindow","editor","commandOverall","ctx","cmd","val","execCommand","err","commandInsert","name","getNode","_range","selectNode","collapse","_menu","toggleNode","commandBlock","effectNode","commandWrap","tag","commandLink","initToolbar","icons","inputStr","_toolbar","toolList","klass","querySelectorAll","createElement","setAttribute","innerHTML","_inputBar","body","appendChild","initEvents","toggleMenu","highlight","menu","outsideClick","updateStatus","getRange","setpos","style","display","addListener","selecting","containsNode","target","removeListener","which","isEmpty","classList","shiftKey","preventDefault","p","insertBefore","focusNode","menuApply","action","_inputActive","focus","createlink","inputValue","onkeypress","checkPlaceholder","checkContentChange","cleanContent","listener","_events","_eventTargets","_eventsCache","addEventListener","triggerListener","args","apply","events","_index","splice","removeEventListener","removeAllListeners","listeners","str","child","byRoot","commonAncestorContainer","el","returnAsNodeName","nodes","empty","range","insertNode","setStartAfter","setEndBefore","setRange","autoLink","tagName","result","urlToLink","links","frag","createDocumentFragment","div","replaceChild","realUrl","displayUrl","hide","hasChildNodes","getRangeSelectedNodes","startContainer","endNode","endContainer","rangeNodes","Error","placeholder","change","_prevContent","getContent","markdown","init","addOnSubmitListener","on","inputElement","form","me","setContent","html","prevContent","currentContent","rangeCount","getRangeAt","createRange","selectNodeContents","removeAllRanges","addRange","focusStart","selectedNodes","selectedParagraphs","item","effects","codeNode","unwrappedNodes","replaceWith","attr","removeAttribute","inputBar","isCollapsed","offset","getBoundingClientRect","menuPadding","top","left","width","menuOffset","x","y","stylesheet","_stylesheet","height","undefined","head","sheet","clientWidth","clientHeight","cssRules","deleteRule","insertRule","onbeforeunload","_isDestroyed","destroy","isAJoke","rebuild","toMd","turndownService","getSelection"],"mappings":"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","file":"pen.js","sourcesContent":["var TurndownService = (function () {\n'use strict';\n\nfunction extend (destination) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i];\n    for (var key in source) {\n      if (source.hasOwnProperty(key)) destination[key] = source[key];\n    }\n  }\n  return destination\n}\n\nfunction repeat (character, count) {\n  return Array(count + 1).join(character)\n}\n\nvar blockElements = [\n  'address', 'article', 'aside', 'audio', 'blockquote', 'body', 'canvas',\n  'center', 'dd', 'dir', 'div', 'dl', 'dt', 'fieldset', 'figcaption',\n  'figure', 'footer', 'form', 'frameset', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',\n  'header', 'hgroup', 'hr', 'html', 'isindex', 'li', 'main', 'menu', 'nav',\n  'noframes', 'noscript', 'ol', 'output', 'p', 'pre', 'section', 'table',\n  'tbody', 'td', 'tfoot', 'th', 'thead', 'tr', 'ul'\n];\n\nfunction isBlock (node) {\n  return blockElements.indexOf(node.nodeName.toLowerCase()) !== -1\n}\n\nvar voidElements = [\n  'area', 'base', 'br', 'col', 'command', 'embed', 'hr', 'img', 'input',\n  'keygen', 'link', 'meta', 'param', 'source', 'track', 'wbr'\n];\n\nfunction isVoid (node) {\n  return voidElements.indexOf(node.nodeName.toLowerCase()) !== -1\n}\n\nvar voidSelector = voidElements.join();\nfunction hasVoid (node) {\n  return node.querySelector && node.querySelector(voidSelector)\n}\n\nvar rules = {};\n\nrules.paragraph = {\n  filter: 'p',\n\n  replacement: function (content) {\n    return '\\n\\n' + content + '\\n\\n'\n  }\n};\n\nrules.lineBreak = {\n  filter: 'br',\n\n  replacement: function (content, node, options) {\n    return options.br + '\\n'\n  }\n};\n\nrules.heading = {\n  filter: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'],\n\n  replacement: function (content, node, options) {\n    var hLevel = Number(node.nodeName.charAt(1));\n\n    if (options.headingStyle === 'setext' && hLevel < 3) {\n      var underline = repeat((hLevel === 1 ? '=' : '-'), content.length);\n      return (\n        '\\n\\n' + content + '\\n' + underline + '\\n\\n'\n      )\n    } else {\n      return '\\n\\n' + repeat('#', hLevel) + ' ' + content + '\\n\\n'\n    }\n  }\n};\n\nrules.blockquote = {\n  filter: 'blockquote',\n\n  replacement: function (content) {\n    content = content.replace(/^\\n+|\\n+$/g, '');\n    content = content.replace(/^/gm, '> ');\n    return '\\n\\n' + content + '\\n\\n'\n  }\n};\n\nrules.list = {\n  filter: ['ul', 'ol'],\n\n  replacement: function (content, node) {\n    var parent = node.parentNode;\n    if (parent.nodeName === 'LI' && parent.lastElementChild === node) {\n      return '\\n' + content\n    } else {\n      return '\\n\\n' + content + '\\n\\n'\n    }\n  }\n};\n\nrules.listItem = {\n  filter: 'li',\n\n  replacement: function (content, node, options) {\n    content = content\n      .replace(/^\\n+/, '') // remove leading newlines\n      .replace(/\\n+$/, '\\n') // replace trailing newlines with just a single one\n      .replace(/\\n/gm, '\\n    '); // indent\n    var prefix = options.bulletListMarker + '   ';\n    var parent = node.parentNode;\n    if (parent.nodeName === 'OL') {\n      var start = parent.getAttribute('start');\n      var index = Array.prototype.indexOf.call(parent.children, node);\n      prefix = (start ? Number(start) + index : index + 1) + '.  ';\n    }\n    return (\n      prefix + content + (node.nextSibling && !/\\n$/.test(content) ? '\\n' : '')\n    )\n  }\n};\n\nrules.indentedCodeBlock = {\n  filter: function (node, options) {\n    return (\n      options.codeBlockStyle === 'indented' &&\n      node.nodeName === 'PRE' &&\n      node.firstChild &&\n      node.firstChild.nodeName === 'CODE'\n    )\n  },\n\n  replacement: function (content, node, options) {\n    return (\n      '\\n\\n    ' +\n      node.firstChild.textContent.replace(/\\n/g, '\\n    ') +\n      '\\n\\n'\n    )\n  }\n};\n\nrules.fencedCodeBlock = {\n  filter: function (node, options) {\n    return (\n      options.codeBlockStyle === 'fenced' &&\n      node.nodeName === 'PRE' &&\n      node.firstChild &&\n      node.firstChild.nodeName === 'CODE'\n    )\n  },\n\n  replacement: function (content, node, options) {\n    var className = node.firstChild.className || '';\n    var language = (className.match(/language-(\\S+)/) || [null, ''])[1];\n\n    return (\n      '\\n\\n' + options.fence + language + '\\n' +\n      node.firstChild.textContent +\n      '\\n' + options.fence + '\\n\\n'\n    )\n  }\n};\n\nrules.horizontalRule = {\n  filter: 'hr',\n\n  replacement: function (content, node, options) {\n    return '\\n\\n' + options.hr + '\\n\\n'\n  }\n};\n\nrules.inlineLink = {\n  filter: function (node, options) {\n    return (\n      options.linkStyle === 'inlined' &&\n      node.nodeName === 'A' &&\n      node.getAttribute('href')\n    )\n  },\n\n  replacement: function (content, node) {\n    var href = node.getAttribute('href');\n    var title = node.title ? ' \"' + node.title + '\"' : '';\n    return '[' + content + '](' + href + title + ')'\n  }\n};\n\nrules.referenceLink = {\n  filter: function (node, options) {\n    return (\n      options.linkStyle === 'referenced' &&\n      node.nodeName === 'A' &&\n      node.getAttribute('href')\n    )\n  },\n\n  replacement: function (content, node, options) {\n    var href = node.getAttribute('href');\n    var title = node.title ? ' \"' + node.title + '\"' : '';\n    var replacement;\n    var reference;\n\n    switch (options.linkReferenceStyle) {\n      case 'collapsed':\n        replacement = '[' + content + '][]';\n        reference = '[' + content + ']: ' + href + title;\n        break\n      case 'shortcut':\n        replacement = '[' + content + ']';\n        reference = '[' + content + ']: ' + href + title;\n        break\n      default:\n        var id = this.references.length + 1;\n        replacement = '[' + content + '][' + id + ']';\n        reference = '[' + id + ']: ' + href + title;\n    }\n\n    this.references.push(reference);\n    return replacement\n  },\n\n  references: [],\n\n  append: function (options) {\n    var references = '';\n    if (this.references.length) {\n      references = '\\n\\n' + this.references.join('\\n') + '\\n\\n';\n      this.references = []; // Reset references\n    }\n    return references\n  }\n};\n\nrules.emphasis = {\n  filter: ['em', 'i'],\n\n  replacement: function (content, node, options) {\n    if (!content.trim()) return ''\n    return options.emDelimiter + content + options.emDelimiter\n  }\n};\n\nrules.strong = {\n  filter: ['strong', 'b'],\n\n  replacement: function (content, node, options) {\n    if (!content.trim()) return ''\n    return options.strongDelimiter + content + options.strongDelimiter\n  }\n};\n\nrules.code = {\n  filter: function (node) {\n    var hasSiblings = node.previousSibling || node.nextSibling;\n    var isCodeBlock = node.parentNode.nodeName === 'PRE' && !hasSiblings;\n\n    return node.nodeName === 'CODE' && !isCodeBlock\n  },\n\n  replacement: function (content) {\n    if (!content.trim()) return ''\n\n    var delimiter = '`';\n    var leadingSpace = '';\n    var trailingSpace = '';\n    var matches = content.match(/`+/gm);\n    if (matches) {\n      if (/^`/.test(content)) leadingSpace = ' ';\n      if (/`$/.test(content)) trailingSpace = ' ';\n      while (matches.indexOf(delimiter) !== -1) delimiter = delimiter + '`';\n    }\n\n    return delimiter + leadingSpace + content + trailingSpace + delimiter\n  }\n};\n\nrules.image = {\n  filter: 'img',\n\n  replacement: function (content, node) {\n    var alt = node.alt || '';\n    var src = node.getAttribute('src') || '';\n    var title = node.title || '';\n    var titlePart = title ? ' \"' + title + '\"' : '';\n    return src ? '![' + alt + ']' + '(' + src + titlePart + ')' : ''\n  }\n};\n\n/**\n * Manages a collection of rules used to convert HTML to Markdown\n */\n\nfunction Rules (options) {\n  this.options = options;\n  this._keep = [];\n  this._remove = [];\n\n  this.blankRule = {\n    replacement: options.blankReplacement\n  };\n\n  this.keepReplacement = options.keepReplacement;\n\n  this.defaultRule = {\n    replacement: options.defaultReplacement\n  };\n\n  this.array = [];\n  for (var key in options.rules) this.array.push(options.rules[key]);\n}\n\nRules.prototype = {\n  add: function (key, rule) {\n    this.array.unshift(rule);\n  },\n\n  keep: function (filter) {\n    this._keep.unshift({\n      filter: filter,\n      replacement: this.keepReplacement\n    });\n  },\n\n  remove: function (filter) {\n    this._remove.unshift({\n      filter: filter,\n      replacement: function () {\n        return ''\n      }\n    });\n  },\n\n  forNode: function (node) {\n    if (node.isBlank) return this.blankRule\n    var rule;\n\n    if ((rule = findRule(this.array, node, this.options))) return rule\n    if ((rule = findRule(this._keep, node, this.options))) return rule\n    if ((rule = findRule(this._remove, node, this.options))) return rule\n\n    return this.defaultRule\n  },\n\n  forEach: function (fn) {\n    for (var i = 0; i < this.array.length; i++) fn(this.array[i], i);\n  }\n};\n\nfunction findRule (rules, node, options) {\n  for (var i = 0; i < rules.length; i++) {\n    var rule = rules[i];\n    if (filterValue(rule, node, options)) return rule\n  }\n  return void 0\n}\n\nfunction filterValue (rule, node, options) {\n  var filter = rule.filter;\n  if (typeof filter === 'string') {\n    if (filter === node.nodeName.toLowerCase()) return true\n  } else if (Array.isArray(filter)) {\n    if (filter.indexOf(node.nodeName.toLowerCase()) > -1) return true\n  } else if (typeof filter === 'function') {\n    if (filter.call(rule, node, options)) return true\n  } else {\n    throw new TypeError('`filter` needs to be a string, array, or function')\n  }\n}\n\n/**\n * The collapseWhitespace function is adapted from collapse-whitespace\n * by Luc Thevenard.\n *\n * The MIT License (MIT)\n *\n * Copyright (c) 2014 Luc Thevenard <lucthevenard@gmail.com>\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in\n * all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n * THE SOFTWARE.\n */\n\n/**\n * collapseWhitespace(options) removes extraneous whitespace from an the given element.\n *\n * @param {Object} options\n */\nfunction collapseWhitespace (options) {\n  var element = options.element;\n  var isBlock = options.isBlock;\n  var isVoid = options.isVoid;\n  var isPre = options.isPre || function (node) {\n    return node.nodeName === 'PRE'\n  };\n\n  if (!element.firstChild || isPre(element)) return\n\n  var prevText = null;\n  var prevVoid = false;\n\n  var prev = null;\n  var node = next(prev, element, isPre);\n\n  while (node !== element) {\n    if (node.nodeType === 3 || node.nodeType === 4) { // Node.TEXT_NODE or Node.CDATA_SECTION_NODE\n      var text = node.data.replace(/[ \\r\\n\\t]+/g, ' ');\n\n      if ((!prevText || / $/.test(prevText.data)) &&\n          !prevVoid && text[0] === ' ') {\n        text = text.substr(1);\n      }\n\n      // `text` might be empty at this point.\n      if (!text) {\n        node = remove(node);\n        continue\n      }\n\n      node.data = text;\n\n      prevText = node;\n    } else if (node.nodeType === 1) { // Node.ELEMENT_NODE\n      if (isBlock(node) || node.nodeName === 'BR') {\n        if (prevText) {\n          prevText.data = prevText.data.replace(/ $/, '');\n        }\n\n        prevText = null;\n        prevVoid = false;\n      } else if (isVoid(node)) {\n        // Avoid trimming space around non-block, non-BR void elements.\n        prevText = null;\n        prevVoid = true;\n      }\n    } else {\n      node = remove(node);\n      continue\n    }\n\n    var nextNode = next(prev, node, isPre);\n    prev = node;\n    node = nextNode;\n  }\n\n  if (prevText) {\n    prevText.data = prevText.data.replace(/ $/, '');\n    if (!prevText.data) {\n      remove(prevText);\n    }\n  }\n}\n\n/**\n * remove(node) removes the given node from the DOM and returns the\n * next node in the sequence.\n *\n * @param {Node} node\n * @return {Node} node\n */\nfunction remove (node) {\n  var next = node.nextSibling || node.parentNode;\n\n  node.parentNode.removeChild(node);\n\n  return next\n}\n\n/**\n * next(prev, current, isPre) returns the next node in the sequence, given the\n * current and previous nodes.\n *\n * @param {Node} prev\n * @param {Node} current\n * @param {Function} isPre\n * @return {Node}\n */\nfunction next (prev, current, isPre) {\n  if ((prev && prev.parentNode === current) || isPre(current)) {\n    return current.nextSibling || current.parentNode\n  }\n\n  return current.firstChild || current.nextSibling || current.parentNode\n}\n\n/*\n * Set up window for Node.js\n */\n\nvar root = (typeof window !== 'undefined' ? window : {});\n\n/*\n * Parsing HTML strings\n */\n\nfunction canParseHTMLNatively () {\n  var Parser = root.DOMParser;\n  var canParse = false;\n\n  // Adapted from https://gist.github.com/1129031\n  // Firefox/Opera/IE throw errors on unsupported types\n  try {\n    // WebKit returns null on unsupported types\n    if (new Parser().parseFromString('', 'text/html')) {\n      canParse = true;\n    }\n  } catch (e) {}\n\n  return canParse\n}\n\nfunction createHTMLParser () {\n  var Parser = function () {};\n\n  {\n    if (shouldUseActiveX()) {\n      Parser.prototype.parseFromString = function (string) {\n        var doc = new window.ActiveXObject('htmlfile');\n        doc.designMode = 'on'; // disable on-page scripts\n        doc.open();\n        doc.write(string);\n        doc.close();\n        return doc\n      };\n    } else {\n      Parser.prototype.parseFromString = function (string) {\n        var doc = document.implementation.createHTMLDocument('');\n        doc.open();\n        doc.write(string);\n        doc.close();\n        return doc\n      };\n    }\n  }\n  return Parser\n}\n\nfunction shouldUseActiveX () {\n  var useActiveX = false;\n  try {\n    document.implementation.createHTMLDocument('').open();\n  } catch (e) {\n    if (window.ActiveXObject) useActiveX = true;\n  }\n  return useActiveX\n}\n\nvar HTMLParser = canParseHTMLNatively() ? root.DOMParser : createHTMLParser();\n\nfunction RootNode (input) {\n  var root;\n  if (typeof input === 'string') {\n    var doc = htmlParser().parseFromString(\n      // DOM parsers arrange elements in the <head> and <body>.\n      // Wrapping in a custom element ensures elements are reliably arranged in\n      // a single element.\n      '<x-turndown id=\"turndown-root\">' + input + '</x-turndown>',\n      'text/html'\n    );\n    root = doc.getElementById('turndown-root');\n  } else {\n    root = input.cloneNode(true);\n  }\n  collapseWhitespace({\n    element: root,\n    isBlock: isBlock,\n    isVoid: isVoid\n  });\n\n  return root\n}\n\nvar _htmlParser;\nfunction htmlParser () {\n  _htmlParser = _htmlParser || new HTMLParser();\n  return _htmlParser\n}\n\nfunction Node (node) {\n  node.isBlock = isBlock(node);\n  node.isCode = node.nodeName.toLowerCase() === 'code' || node.parentNode.isCode;\n  node.isBlank = isBlank(node);\n  node.flankingWhitespace = flankingWhitespace(node);\n  return node\n}\n\nfunction isBlank (node) {\n  return (\n    ['A', 'TH', 'TD'].indexOf(node.nodeName) === -1 &&\n    /^\\s*$/i.test(node.textContent) &&\n    !isVoid(node) &&\n    !hasVoid(node)\n  )\n}\n\nfunction flankingWhitespace (node) {\n  var leading = '';\n  var trailing = '';\n\n  if (!node.isBlock) {\n    var hasLeading = /^[ \\r\\n\\t]/.test(node.textContent);\n    var hasTrailing = /[ \\r\\n\\t]$/.test(node.textContent);\n\n    if (hasLeading && !isFlankedByWhitespace('left', node)) {\n      leading = ' ';\n    }\n    if (hasTrailing && !isFlankedByWhitespace('right', node)) {\n      trailing = ' ';\n    }\n  }\n\n  return { leading: leading, trailing: trailing }\n}\n\nfunction isFlankedByWhitespace (side, node) {\n  var sibling;\n  var regExp;\n  var isFlanked;\n\n  if (side === 'left') {\n    sibling = node.previousSibling;\n    regExp = / $/;\n  } else {\n    sibling = node.nextSibling;\n    regExp = /^ /;\n  }\n\n  if (sibling) {\n    if (sibling.nodeType === 3) {\n      isFlanked = regExp.test(sibling.nodeValue);\n    } else if (sibling.nodeType === 1 && !isBlock(sibling)) {\n      isFlanked = regExp.test(sibling.textContent);\n    }\n  }\n  return isFlanked\n}\n\nvar reduce = Array.prototype.reduce;\nvar leadingNewLinesRegExp = /^\\n*/;\nvar trailingNewLinesRegExp = /\\n*$/;\n\nfunction TurndownService (options) {\n  if (!(this instanceof TurndownService)) return new TurndownService(options)\n\n  var defaults = {\n    rules: rules,\n    headingStyle: 'setext',\n    hr: '* * *',\n    bulletListMarker: '*',\n    codeBlockStyle: 'indented',\n    fence: '```',\n    emDelimiter: '_',\n    strongDelimiter: '**',\n    linkStyle: 'inlined',\n    linkReferenceStyle: 'full',\n    br: '  ',\n    blankReplacement: function (content, node) {\n      return node.isBlock ? '\\n\\n' : ''\n    },\n    keepReplacement: function (content, node) {\n      return node.isBlock ? '\\n\\n' + node.outerHTML + '\\n\\n' : node.outerHTML\n    },\n    defaultReplacement: function (content, node) {\n      return node.isBlock ? '\\n\\n' + content + '\\n\\n' : content\n    }\n  };\n  this.options = extend({}, defaults, options);\n  this.rules = new Rules(this.options);\n}\n\nTurndownService.prototype = {\n  /**\n   * The entry point for converting a string or DOM node to Markdown\n   * @public\n   * @param {String|HTMLElement} input The string or DOM node to convert\n   * @returns A Markdown representation of the input\n   * @type String\n   */\n\n  turndown: function (input) {\n    if (!canConvert(input)) {\n      throw new TypeError(\n        input + ' is not a string, or an element/document/fragment node.'\n      )\n    }\n\n    if (input === '') return ''\n\n    var output = process.call(this, new RootNode(input));\n    return postProcess.call(this, output)\n  },\n\n  /**\n   * Add one or more plugins\n   * @public\n   * @param {Function|Array} plugin The plugin or array of plugins to add\n   * @returns The Turndown instance for chaining\n   * @type Object\n   */\n\n  use: function (plugin) {\n    if (Array.isArray(plugin)) {\n      for (var i = 0; i < plugin.length; i++) this.use(plugin[i]);\n    } else if (typeof plugin === 'function') {\n      plugin(this);\n    } else {\n      throw new TypeError('plugin must be a Function or an Array of Functions')\n    }\n    return this\n  },\n\n  /**\n   * Adds a rule\n   * @public\n   * @param {String} key The unique key of the rule\n   * @param {Object} rule The rule\n   * @returns The Turndown instance for chaining\n   * @type Object\n   */\n\n  addRule: function (key, rule) {\n    this.rules.add(key, rule);\n    return this\n  },\n\n  /**\n   * Keep a node (as HTML) that matches the filter\n   * @public\n   * @param {String|Array|Function} filter The unique key of the rule\n   * @returns The Turndown instance for chaining\n   * @type Object\n   */\n\n  keep: function (filter) {\n    this.rules.keep(filter);\n    return this\n  },\n\n  /**\n   * Remove a node that matches the filter\n   * @public\n   * @param {String|Array|Function} filter The unique key of the rule\n   * @returns The Turndown instance for chaining\n   * @type Object\n   */\n\n  remove: function (filter) {\n    this.rules.remove(filter);\n    return this\n  },\n\n  /**\n   * Escapes Markdown syntax\n   * @public\n   * @param {String} string The string to escape\n   * @returns A string with Markdown syntax escaped\n   * @type String\n   */\n\n  escape: function (string) {\n    return (\n      string\n        // Escape backslash escapes!\n        .replace(/\\\\(\\S)/g, '\\\\\\\\$1')\n\n        // Escape headings\n        .replace(/^(#{1,6} )/gm, '\\\\$1')\n\n        // Escape hr\n        .replace(/^([-*_] *){3,}$/gm, function (match, character) {\n          return match.split(character).join('\\\\' + character)\n        })\n\n        // Escape ol bullet points\n        .replace(/^(\\W* {0,3})(\\d+)\\. /gm, '$1$2\\\\. ')\n\n        // Escape ul bullet points\n        .replace(/^([^\\\\\\w]*)[*+-] /gm, function (match) {\n          return match.replace(/([*+-])/g, '\\\\$1')\n        })\n\n        // Escape blockquote indents\n        .replace(/^(\\W* {0,3})> /gm, '$1\\\\> ')\n\n        // Escape em/strong *\n        .replace(/\\*+(?![*\\s\\W]).+?\\*+/g, function (match) {\n          return match.replace(/\\*/g, '\\\\*')\n        })\n\n        // Escape em/strong _\n        .replace(/_+(?![_\\s\\W]).+?_+/g, function (match) {\n          return match.replace(/_/g, '\\\\_')\n        })\n\n        // Escape code _\n        .replace(/`+(?![`\\s\\W]).+?`+/g, function (match) {\n          return match.replace(/`/g, '\\\\`')\n        })\n\n        // Escape link brackets\n        .replace(/[\\[\\]]/g, '\\\\$&') // eslint-disable-line no-useless-escape\n    )\n  }\n};\n\n/**\n * Reduces a DOM node down to its Markdown string equivalent\n * @private\n * @param {HTMLElement} parentNode The node to convert\n * @returns A Markdown representation of the node\n * @type String\n */\n\nfunction process (parentNode) {\n  var self = this;\n  return reduce.call(parentNode.childNodes, function (output, node) {\n    node = new Node(node);\n\n    var replacement = '';\n    if (node.nodeType === 3) {\n      replacement = node.isCode ? node.nodeValue : self.escape(node.nodeValue);\n    } else if (node.nodeType === 1) {\n      replacement = replacementForNode.call(self, node);\n    }\n\n    return join(output, replacement)\n  }, '')\n}\n\n/**\n * Appends strings as each rule requires and trims the output\n * @private\n * @param {String} output The conversion output\n * @returns A trimmed version of the ouput\n * @type String\n */\n\nfunction postProcess (output) {\n  var self = this;\n  this.rules.forEach(function (rule) {\n    if (typeof rule.append === 'function') {\n      output = join(output, rule.append(self.options));\n    }\n  });\n\n  return output.replace(/^[\\t\\r\\n]+/, '').replace(/[\\t\\r\\n\\s]+$/, '')\n}\n\n/**\n * Converts an element node to its Markdown equivalent\n * @private\n * @param {HTMLElement} node The node to convert\n * @returns A Markdown representation of the node\n * @type String\n */\n\nfunction replacementForNode (node) {\n  var rule = this.rules.forNode(node);\n  var content = process.call(this, node);\n  var whitespace = node.flankingWhitespace;\n  if (whitespace.leading || whitespace.trailing) content = content.trim();\n  return (\n    whitespace.leading +\n    rule.replacement(content, node, this.options) +\n    whitespace.trailing\n  )\n}\n\n/**\n * Determines the new lines between the current output and the replacement\n * @private\n * @param {String} output The current conversion output\n * @param {String} replacement The string to append to the output\n * @returns The whitespace to separate the current output and the replacement\n * @type String\n */\n\nfunction separatingNewlines (output, replacement) {\n  var newlines = [\n    output.match(trailingNewLinesRegExp)[0],\n    replacement.match(leadingNewLinesRegExp)[0]\n  ].sort();\n  var maxNewlines = newlines[newlines.length - 1];\n  return maxNewlines.length < 2 ? maxNewlines : '\\n\\n'\n}\n\nfunction join (string1, string2) {\n  var separator = separatingNewlines(string1, string2);\n\n  // Remove trailing/leading newlines and replace with separator\n  string1 = string1.replace(trailingNewLinesRegExp, '');\n  string2 = string2.replace(leadingNewLinesRegExp, '');\n\n  return string1 + separator + string2\n}\n\n/**\n * Determines whether an input can be converted\n * @private\n * @param {String|HTMLElement} input Describe this parameter\n * @returns Describe what it returns\n * @type String|Object|Array|Boolean|Number\n */\n\nfunction canConvert (input) {\n  return (\n    input != null && (\n      typeof input === 'string' ||\n      (input.nodeType && (\n        input.nodeType === 1 || input.nodeType === 9 || input.nodeType === 11\n      ))\n    )\n  )\n}\n\nreturn TurndownService;\n\n}());\n;/*! Licensed under MIT, https://github.com/sofish/pen */\n(function(root, doc) {\n\n  var Pen, debugMode, selection, utils = {};\n  var toString = Object.prototype.toString;\n  var slice = Array.prototype.slice;\n\n  // allow command list\n  var commandsReg = {\n    block: /^(?:p|h[1-6]|blockquote)$/,\n    inline: /^(?:bold|italic|underline|insertorderedlist|insertunorderedlist|indent|outdent)$/,\n    source: /^(?:createlink|unlink)$/,\n    insert: /^(?:inserthorizontalrule|insertimage|insert)$/,\n    wrap: /^(?:code)$/\n  };\n\n  var lineBreakReg = /^(?:blockquote|pre|div|code)$/i;\n\n  var effectNodeReg = /(?:[pubia]|h[1-6]|blockquote|[uo]l|li|code)/i;\n\n  var strReg = {\n    whiteSpace: /(^\\s+)|(\\s+$)/g,\n    mailTo: /^(?!mailto:|.+\\/|.+#|.+\\?)(.*@.*\\..+)$/,\n    http: /^(?!\\w+?:\\/\\/|mailto:|\\/|\\.\\/|\\?|#)(.*)$/\n  };\n\n  var autoLinkReg = {\n    url: /((https?|ftp):\\/\\/|www\\.)[^\\s<]{3,}/gi,\n    prefix: /^(?:https?|ftp):\\/\\//i,\n    notLink: /^(?:img|a|input|audio|video|source|code|pre|script|head|title|style)$/i,\n    maxLength: 100\n  };\n\n  // type detect\n  utils.is = function(obj, type) {\n    return toString.call(obj).slice(8, -1) === type;\n  };\n\n  utils.forEach = function(obj, iterator, arrayLike) {\n    if (!obj) return;\n    if (arrayLike == null) arrayLike = utils.is(obj, 'Array');\n    if (arrayLike) {\n      for (var i = 0, l = obj.length; i < l; i++) iterator(obj[i], i, obj);\n    } else {\n      for (var key in obj) {\n        if (obj.hasOwnProperty(key)) iterator(obj[key], key, obj);\n      }\n    }\n  };\n\n  // copy props from a obj\n  utils.copy = function(defaults, source) {\n    utils.forEach(source, function (value, key) {\n      defaults[key] = utils.is(value, 'Object') ? utils.copy({}, value) :\n        utils.is(value, 'Array') ? utils.copy([], value) : value;\n    });\n    return defaults;\n  };\n\n  // log\n  utils.log = function(message, force) {\n    if (debugMode || force)\n      console.log('%cPEN DEBUGGER: %c' + message, 'font-family:arial,sans-serif;color:#1abf89;line-height:2em;', 'font-family:cursor,monospace;color:#333;');\n  };\n\n  utils.delayExec = function (fn) {\n    var timer = null;\n    return function (delay) {\n      clearTimeout(timer);\n      timer = setTimeout(function() {\n        fn();\n      }, delay || 1);\n    };\n  };\n\n  // merge: make it easy to have a fallback\n  utils.merge = function(config) {\n\n    // default settings\n    var defaults = {\n      class: 'pen',\n      debug: false,\n      toolbar: null, // custom toolbar\n      stay: config.stay || !config.debug,\n      stayMsg: 'Are you going to leave here?',\n      textarea: '<textarea name=\"content\"></textarea>',\n      list: [\n        'blockquote', 'h2', 'h3', 'p', 'code', 'insertorderedlist', 'insertunorderedlist', 'inserthorizontalrule',\n        'indent', 'outdent', 'bold', 'italic', 'underline', 'createlink', 'insertimage'\n      ],\n      titles: {},\n      cleanAttrs: ['id', 'class', 'style', 'name'],\n      cleanTags: ['script'],\n      linksInNewWindow: false\n    };\n\n    // user-friendly config\n    if (config.nodeType === 1) {\n      defaults.editor = config;\n    } else if (config.match && config.match(/^#[\\S]+$/)) {\n      defaults.editor = doc.getElementById(config.slice(1));\n    } else {\n      defaults = utils.copy(defaults, config);\n    }\n\n    return defaults;\n  };\n\n  function commandOverall(ctx, cmd, val) {\n    var message = ' to exec ' + cmd + ' command' + (val ? (' with value: ' + val) : '');\n\n    try {\n      doc.execCommand(cmd, false, val);\n    } catch(err) {\n      // TODO: there's an error when insert a image to document, but not a bug\n      return utils.log('fail' + message, true);\n    }\n\n    utils.log('success' + message);\n  }\n\n  function commandInsert(ctx, name, val) {\n    var node = getNode(ctx);\n    if (!node) return;\n    ctx._range.selectNode(node);\n    ctx._range.collapse(false);\n\n    // hide menu when a image was inserted\n    if(name === 'insertimage' && ctx._menu) toggleNode(ctx._menu, true);\n\n    return commandOverall(ctx, name, val);\n  }\n\n  function commandBlock(ctx, name) {\n    var list = effectNode(ctx, getNode(ctx), true);\n    if (list.indexOf(name) !== -1) name = 'p';\n    return commandOverall(ctx, 'formatblock', name);\n  }\n\n  function commandWrap(ctx, tag, value) {\n    value = '<' + tag + '>' + (value||selection.toString()) + '</' + tag + '>';\n    return commandOverall(ctx, 'insertHTML', value);\n  }\n\n  function commandLink(ctx, tag, value) {\n    if (ctx.config.linksInNewWindow) {\n      value = '<a href=\"' + value + '\" target=\"_blank\">' + (selection.toString()) + '</a>';\n      return commandOverall(ctx, 'insertHTML', value);\n    } else {\n      return commandOverall(ctx, tag, value);\n    }\n  }\n\n  function initToolbar(ctx) {\n    var icons = '', inputStr = '<input class=\"pen-input\" placeholder=\"http://\" />';\n\n    ctx._toolbar = ctx.config.toolbar;\n    if (!ctx._toolbar) {\n      var toolList = ctx.config.list;\n      utils.forEach(toolList, function (name) {\n        var klass = 'pen-icon icon-' + name;\n        var title = ctx.config.titles[name] || '';\n        icons += '<i class=\"' + klass + '\" data-action=\"' + name + '\" title=\"' + title + '\"></i>';\n      }, true);\n      if (toolList.indexOf('createlink') >= 0 || toolList.indexOf('insertimage') >= 0)\n        icons += inputStr;\n    } else if (ctx._toolbar.querySelectorAll('[data-action=createlink]').length ||\n      ctx._toolbar.querySelectorAll('[data-action=insertimage]').length) {\n      icons += inputStr;\n    }\n\n    if (icons) {\n      ctx._menu = doc.createElement('div');\n      ctx._menu.setAttribute('class', ctx.config.class + '-menu pen-menu');\n      ctx._menu.innerHTML = icons;\n      ctx._inputBar = ctx._menu.querySelector('input');\n      toggleNode(ctx._menu, true);\n      doc.body.appendChild(ctx._menu);\n    }\n    if (ctx._toolbar && ctx._inputBar) toggleNode(ctx._inputBar);\n  }\n\n  function initEvents(ctx) {\n    var toolbar = ctx._toolbar || ctx._menu, editor = ctx.config.editor;\n\n    var toggleMenu = utils.delayExec(function() {\n      ctx.highlight().menu();\n    });\n    var outsideClick = function() {};\n\n    function updateStatus(delay) {\n      ctx._range = ctx.getRange();\n      toggleMenu(delay);\n    }\n\n    if (ctx._menu) {\n      var setpos = function() {\n        if (ctx._menu.style.display === 'block') ctx.menu();\n      };\n\n      // change menu offset when window resize / scroll\n      addListener(ctx, root, 'resize', setpos);\n      addListener(ctx, root, 'scroll', setpos);\n\n      // toggle toolbar on mouse select\n      var selecting = false;\n      addListener(ctx, editor, 'mousedown', function() {\n        selecting = true;\n      });\n      addListener(ctx, editor, 'mouseleave', function() {\n        if (selecting) updateStatus(800);\n        selecting = false;\n      });\n      addListener(ctx, editor, 'mouseup', function() {\n        if (selecting) updateStatus(100);\n        selecting = false;\n      });\n      // Hide menu when focusing outside of editor\n      outsideClick = function(e) {\n        if (ctx._menu && !containsNode(editor, e.target) && !containsNode(ctx._menu, e.target)) {\n          removeListener(ctx, doc, 'click', outsideClick);\n          toggleMenu(100);\n        }\n      };\n    } else {\n      addListener(ctx, editor, 'click', function() {\n        updateStatus(0);\n      });\n    }\n\n    addListener(ctx, editor, 'keyup', function(e) {\n      if (e.which === 8 && ctx.isEmpty()) return lineBreak(ctx, true);\n    });\n\n    // check line break\n    addListener(ctx, editor, 'keydown', function(e) {\n      editor.classList.remove('pen-placeholder');\n      if (e.which !== 13 || e.shiftKey) return;\n      var node = getNode(ctx, true);\n      if (!node || !lineBreakReg.test(node.nodeName)) return;\n      if (node.nodeName === 'CODE') {\n        node = node.parentNode;\n      }\n      // quit block mode for 2 'enter'\n      e.preventDefault();\n      var p = doc.createElement('p');\n      p.innerHTML = '<br>';\n      if (!node.nextSibling) node.parentNode.appendChild(p);\n      else node.parentNode.insertBefore(p, node.nextSibling);\n      focusNode(ctx, p, ctx.getRange());\n    });\n\n    var menuApply = function(action, value) {\n      ctx.execCommand(action, value);\n      ctx._range = ctx.getRange();\n      ctx.highlight().menu();\n    };\n\n    // toggle toolbar on key select\n    addListener(ctx, toolbar, 'click', function(e) {\n      var node = e.target, action;\n\n      while (node !== toolbar && !(action = node.getAttribute('data-action'))) {\n        node = node.parentNode;\n      }\n\n      if (!action) return;\n      if (!/(?:createlink)|(?:insertimage)/.test(action)) return menuApply(action);\n      if (!ctx._inputBar) return;\n\n      // create link\n      var input = ctx._inputBar;\n      if (toolbar === ctx._menu) toggleNode(input);\n      else {\n        ctx._inputActive = true;\n        ctx.menu();\n      }\n      if (ctx._menu.style.display === 'none') return;\n\n      setTimeout(function() { input.focus(); }, 400);\n      var createlink = function() {\n        var inputValue = input.value;\n\n        if (!inputValue) action = 'unlink';\n        else {\n          inputValue = input.value\n            .replace(strReg.whiteSpace, '')\n            .replace(strReg.mailTo, 'mailto:$1')\n            .replace(strReg.http, 'http://$1');\n        }\n        menuApply(action, inputValue);\n        if (toolbar === ctx._menu) toggleNode(input, false);\n        else toggleNode(ctx._menu, true);\n      };\n\n      input.onkeypress = function(e) {\n        if (e.which === 13) return createlink();\n      };\n\n    });\n\n    // listen for placeholder\n    addListener(ctx, editor, 'focus', function() {\n      if (ctx.isEmpty()) lineBreak(ctx, true);\n      addListener(ctx, doc, 'click', outsideClick);\n    });\n\n    addListener(ctx, editor, 'blur', function() {\n      checkPlaceholder(ctx);\n      ctx.checkContentChange();\n    });\n\n    // listen for paste and clear style\n    addListener(ctx, editor, 'paste', function() {\n      setTimeout(function() {\n        ctx.cleanContent();\n      });\n    });\n  }\n\n  function addListener(ctx, target, type, listener) {\n    if (ctx._events.hasOwnProperty(type)) {\n      ctx._events[type].push(listener);\n    } else {\n      ctx._eventTargets = ctx._eventTargets || [];\n      ctx._eventsCache = ctx._eventsCache || [];\n      var index = ctx._eventTargets.indexOf(target);\n      if (index < 0) index = ctx._eventTargets.push(target) - 1;\n      ctx._eventsCache[index] = ctx._eventsCache[index] || {};\n      ctx._eventsCache[index][type] = ctx._eventsCache[index][type] || [];\n      ctx._eventsCache[index][type].push(listener);\n\n      target.addEventListener(type, listener, false);\n    }\n    return ctx;\n  }\n\n  // trigger local events\n  function triggerListener(ctx, type) {\n    if (!ctx._events.hasOwnProperty(type)) return;\n    var args = slice.call(arguments, 2);\n    utils.forEach(ctx._events[type], function (listener) {\n      listener.apply(ctx, args);\n    });\n  }\n\n  function removeListener(ctx, target, type, listener) {\n    var events = ctx._events[type];\n    if (!events) {\n      var _index = ctx._eventTargets.indexOf(target);\n      if (_index >= 0) events = ctx._eventsCache[_index][type];\n    }\n    if (!events) return ctx;\n    var index = events.indexOf(listener);\n    if (index >= 0) events.splice(index, 1);\n    target.removeEventListener(type, listener, false);\n    return ctx;\n  }\n\n  function removeAllListeners(ctx) {\n    utils.forEach(this._events, function (events) {\n      events.length = 0;\n    }, false);\n    if (!ctx._eventsCache) return ctx;\n    utils.forEach(ctx._eventsCache, function (events, index) {\n      var target = ctx._eventTargets[index];\n      utils.forEach(events, function (listeners, type) {\n        utils.forEach(listeners, function (listener) {\n          target.removeEventListener(type, listener, false);\n        }, true);\n      }, false);\n    }, true);\n    ctx._eventTargets = [];\n    ctx._eventsCache = [];\n    return ctx;\n  }\n\n  function checkPlaceholder(ctx) {\n    ctx.config.editor.classList[ctx.isEmpty() ? 'add' : 'remove']('pen-placeholder');\n  }\n\n  function trim(str) {\n    return (str || '').replace(/^\\s+|\\s+$/g, '');\n  }\n\n  // node.contains is not implemented in IE10/IE11\n  function containsNode(parent, child) {\n    if (parent === child) return true;\n    child = child.parentNode;\n    while (child) {\n      if (child === parent) return true;\n      child = child.parentNode;\n    }\n    return false;\n  }\n\n  function getNode(ctx, byRoot) {\n    var node, root = ctx.config.editor;\n    ctx._range = ctx.getRange();\n    node = ctx._range.commonAncestorContainer;\n    if (!node || node === root) return null;\n    while (node && (node.nodeType !== 1) && (node.parentNode !== root)) node = node.parentNode;\n    while (node && byRoot && (node.parentNode !== root)) node = node.parentNode;\n    return containsNode(root, node) ? node : null;\n  }\n\n  // node effects\n  function effectNode(ctx, el, returnAsNodeName) {\n    var nodes = [];\n    el = el || ctx.config.editor;\n    while (el && el !== ctx.config.editor) {\n      if (el.nodeName.match(effectNodeReg)) {\n        nodes.push(returnAsNodeName ? el.nodeName.toLowerCase() : el);\n      }\n      el = el.parentNode;\n    }\n    return nodes;\n  }\n\n  // breakout from node\n  function lineBreak(ctx, empty) {\n    var range = ctx._range = ctx.getRange(), node = doc.createElement('p');\n    if (empty) ctx.config.editor.innerHTML = '';\n    node.innerHTML = '<br>';\n    range.insertNode(node);\n    focusNode(ctx, node.childNodes[0], range);\n  }\n\n  function focusNode(ctx, node, range) {\n    range.setStartAfter(node);\n    range.setEndBefore(node);\n    range.collapse(false);\n    ctx.setRange(range);\n  }\n\n  function autoLink(node) {\n    if (node.nodeType === 1) {\n      if (autoLinkReg.notLink.test(node.tagName)) return;\n      utils.forEach(node.childNodes, function (child) {\n        autoLink(child);\n      }, true);\n    } else if (node.nodeType === 3) {\n      var result = urlToLink(node.nodeValue || '');\n      if (!result.links) return;\n      var frag = doc.createDocumentFragment(),\n        div = doc.createElement('div');\n      div.innerHTML = result.text;\n      while (div.childNodes.length) frag.appendChild(div.childNodes[0]);\n      node.parentNode.replaceChild(frag, node);\n    }\n  }\n\n  function urlToLink(str) {\n    var count = 0;\n    str = str.replace(autoLinkReg.url, function(url) {\n      var realUrl = url, displayUrl = url;\n      count++;\n      if (url.length > autoLinkReg.maxLength) displayUrl = url.slice(0, autoLinkReg.maxLength) + '...';\n      // Add http prefix if necessary\n      if (!autoLinkReg.prefix.test(realUrl)) realUrl = 'http://' + realUrl;\n      return '<a href=\"' + realUrl + '\">' + displayUrl + '</a>';\n    });\n    return {links: count, text: str};\n  }\n\n  function toggleNode(node, hide) {\n    node.style.display = hide ? 'none' : 'block';\n  }\n\n  function nextNode(node) {\n    if (node.hasChildNodes()) {\n      return node.firstChild;\n    } else {\n      while (node && !node.nextSibling) {\n        node = node.parentNode;\n      }\n      if (!node) {\n        return null;\n      }\n      return node.nextSibling;\n    }\n  }\n\n  function getRangeSelectedNodes(range) {\n    var node = range.startContainer;\n    var endNode = range.endContainer;\n\n    // Special case for a range that is contained within a single node\n    if (node === endNode) {\n      return [node];\n    }\n\n    // Iterate nodes until we hit the end container\n    var rangeNodes = [];\n    while (node && node !== endNode) {\n      rangeNodes.push(node = nextNode(node));\n    }\n\n    // Add partially selected nodes at the start of the range\n    node = range.startContainer;\n    while (node && node !== range.commonAncestorContainer) {\n      rangeNodes.unshift(node);\n      node = node.parentNode;\n    }\n\n    return rangeNodes;\n  }\n\n  Pen = function(config) {\n\n    if (!config) throw new Error('Can\\'t find config');\n\n    debugMode = config.debug;\n\n    // merge user config\n    var defaults = utils.merge(config);\n\n    var editor = defaults.editor;\n\n    if (!editor || editor.nodeType !== 1) throw new Error('Can\\'t find editor');\n\n    // set default class\n    editor.classList.add(defaults.class);\n\n    // set contenteditable\n    editor.setAttribute('contenteditable', 'true');\n\n    // assign config\n    this.config = defaults;\n\n    // set placeholder\n    if (defaults.placeholder) editor.setAttribute('data-placeholder', defaults.placeholder);\n    checkPlaceholder(this);\n\n    // save the selection obj\n    this.selection = selection;\n\n    // define local events\n    this._events = {change: []};\n\n    // enable toolbar\n    initToolbar(this);\n\n    // init events\n    initEvents(this);\n\n    // to check content change\n    this._prevContent = this.getContent();\n\n    // enable markdown covert\n    if (this.markdown) this.markdown.init(this);\n\n    // stay on the page\n    if (this.config.stay) this.stay(this.config);\n\n    if(this.config.input) {\n      this.addOnSubmitListener(this.config.input);\n    }\n  };\n\n  Pen.prototype.on = function(type, listener) {\n    addListener(this, this.config.editor, type, listener);\n    return this;\n  };\n\n  Pen.prototype.addOnSubmitListener = function(inputElement) {\n    var form = inputElement.form;\n    var me = this;\n    form.addEventListener(\"submit\", function() {\n      inputElement.value = me.config.editor.innerHTML;\n    });\n  };\n\n  Pen.prototype.isEmpty = function(node) {\n    node = node || this.config.editor;\n    return !(node.querySelector('img')) && !(node.querySelector('blockquote')) &&\n      !(node.querySelector('li')) && !trim(node.textContent);\n  };\n\n  Pen.prototype.getContent = function() {\n    return this.isEmpty() ?  '' : trim(this.config.editor.innerHTML);\n  };\n\n  Pen.prototype.setContent = function(html) {\n    this.config.editor.innerHTML = html;\n    this.cleanContent();\n    return this;\n  };\n\n  Pen.prototype.checkContentChange = function () {\n    var prevContent = this._prevContent, currentContent = this.getContent();\n    if (prevContent === currentContent) return;\n    this._prevContent = currentContent;\n    triggerListener(this, 'change', currentContent, prevContent);\n  };\n\n  Pen.prototype.getRange = function() {\n    var editor = this.config.editor, range = selection.rangeCount && selection.getRangeAt(0);\n    if (!range) range = doc.createRange();\n    if (!containsNode(editor, range.commonAncestorContainer)) {\n      range.selectNodeContents(editor);\n      range.collapse(false);\n    }\n    return range;\n  };\n\n  Pen.prototype.setRange = function(range) {\n    range = range || this._range;\n    if (!range) {\n      range = this.getRange();\n      range.collapse(false); // set to end\n    }\n    try {\n      selection.removeAllRanges();\n      selection.addRange(range);\n    } catch (e) {/* IE throws error sometimes*/}\n    return this;\n  };\n\n  Pen.prototype.focus = function(focusStart) {\n    if (!focusStart) this.setRange();\n    this.config.editor.focus();\n    return this;\n  };\n\n  Pen.prototype.execCommand = function(name, value) {\n    name = name.toLowerCase();\n\n    if (name === 'codeblock') {\n      this.selection.focusNode.innerHTML = '<code><br></code>';\n      commandBlock(this, 'pre');\n    } else if (commandsReg.block.test(name)) {\n      commandBlock(this, name);\n    } else if (commandsReg.inline.test(name)) {\n      commandOverall(this, name, value);\n    } else if (commandsReg.source.test(name)) {\n      this.setRange();\n      commandLink(this, name, value);\n    } else if (commandsReg.insert.test(name)) {\n      this.setRange();\n      commandInsert(this, name, value);\n    } else if (commandsReg.wrap.test(name)) {\n      let selectedNodes = getRangeSelectedNodes(this.selection.getRangeAt(0));\n      let selectedParagraphs = 0;\n      utils.forEach(selectedNodes, function(item) {\n        if (item.nodeName === 'P') {\n          selectedParagraphs++;\n        }\n      });\n      if (selectedParagraphs < 2) {\n        // TODO: this.selection.focusNode works weird if FF, double click on word selects word/element to the right of target\n        let effects = effectNode(this, this.selection.focusNode);\n        let codeNode;\n        utils.forEach(effects, function(item) {\n          if (item.nodeName === 'CODE') {\n            codeNode = item;\n          }\n        });\n        if (codeNode) {\n          // FF does not support removeFormat\n          if (!commandOverall(this, 'removeFormat')) {\n            let unwrappedNodes = doc.createDocumentFragment();\n            utils.forEach(codeNode.childNodes, function(item) {\n              unwrappedNodes.appendChild(item.cloneNode());\n            });\n            codeNode.replaceWith(unwrappedNodes);\n          }\n        } else {\n          /**\n           * TODO: does not work when selecting the last element\n           * for some reasons instead of adding <code>value</code>\n           * browsers (FF, Chrome) add <span styles=\"styles\">value</span>\n           */\n          commandWrap(this, name, value);\n        }\n      }\n    } else {\n      utils.log('can not find command function for name: ' + name + (value ? (', value: ' + value) : ''), true);\n    }\n    if (name === 'indent') this.checkContentChange();\n    else this.cleanContent({cleanAttrs: ['style']});\n  };\n\n  // remove attrs and tags\n  // pen.cleanContent({cleanAttrs: ['style'], cleanTags: ['id']})\n  Pen.prototype.cleanContent = function(options) {\n    var editor = this.config.editor;\n\n    if (!options) options = this.config;\n    utils.forEach(options.cleanAttrs, function (attr) {\n      utils.forEach(editor.querySelectorAll('[' + attr + ']'), function(item) {\n        item.removeAttribute(attr);\n      }, true);\n    }, true);\n    utils.forEach(options.cleanTags, function (tag) {\n      utils.forEach(editor.querySelectorAll(tag), function(item) {\n        item.parentNode.removeChild(item);\n      }, true);\n    }, true);\n\n    checkPlaceholder(this);\n    this.checkContentChange();\n    return this;\n  };\n\n  // auto link content, return content\n  Pen.prototype.autoLink = function() {\n    autoLink(this.config.editor);\n    return this.getContent();\n  };\n\n  // highlight menu\n\n  // TODO: do not display some actions if selection is inside code block (this is how it works in Slack)\n  Pen.prototype.highlight = function() {\n    var toolbar = this._toolbar || this._menu\n      , node = getNode(this);\n    // remove all highlights\n    utils.forEach(toolbar.querySelectorAll('.active'), function(el) {\n      el.classList.remove('active');\n    }, true);\n\n    if (!node) return this;\n\n    var effects = effectNode(this, node)\n      , inputBar = this._inputBar\n      , highlight;\n\n    if (inputBar && toolbar === this._menu) {\n      // display link input if createlink enabled\n      inputBar.style.display = 'none';\n      // reset link input value\n      inputBar.value = '';\n    }\n\n    highlight = function(str) {\n      if (!str) return;\n      var el = toolbar.querySelector('[data-action=' + str + ']');\n      return el && el.classList.add('active');\n    };\n    utils.forEach(effects, function(item) {\n      var tag = item.nodeName.toLowerCase();\n      switch(tag) {\n        case 'a':\n          if (inputBar) inputBar.value = item.getAttribute('href');\n          tag = 'createlink';\n          break;\n        case 'img':\n          if (inputBar) inputBar.value = item.getAttribute('src');\n          tag = 'insertimage';\n          break;\n        case 'i':\n          tag = 'italic';\n          break;\n        case 'u':\n          tag = 'underline';\n          break;\n        case 'b':\n          tag = 'bold';\n          break;\n        case 'pre':\n        case 'code':\n          tag = 'code';\n          break;\n        case 'ul':\n          tag = 'insertunorderedlist';\n          break;\n        case 'ol':\n          tag = 'insertorderedlist';\n          break;\n        case 'li':\n          tag = 'indent';\n          break;\n      }\n      highlight(tag);\n    }, true);\n\n    return this;\n  };\n\n  // show menu\n  Pen.prototype.menu = function() {\n    if (!this._menu) return this;\n    if (selection.isCollapsed) {\n      this._menu.style.display = 'none'; //hide menu\n      this._inputActive = false;\n      return this;\n    }\n    if (this._toolbar) {\n      if (!this._inputBar || !this._inputActive) return this;\n    }\n    var offset = this._range.getBoundingClientRect()\n      , menuPadding = 10\n      , top = offset.top - menuPadding\n      , left = offset.left + (offset.width / 2)\n      , menu = this._menu\n      , menuOffset = {x: 0, y: 0}\n      , stylesheet = this._stylesheet;\n\n    // fixes some browser double click visual discontinuity\n    // if the offset has no width or height it should not be used\n    if (offset.width === 0 && offset.height === 0) return this;\n\n    // store the stylesheet used for positioning the menu horizontally\n    if (this._stylesheet === undefined) {\n      var style = document.createElement(\"style\");\n      document.head.appendChild(style);\n      this._stylesheet = stylesheet = style.sheet;\n    }\n    // display block to caculate its width & height\n    menu.style.display = 'block';\n\n    menuOffset.x = left - (menu.clientWidth / 2);\n    menuOffset.y = top - menu.clientHeight;\n\n    // check to see if menu has over-extended its bounding box. if it has,\n    // 1) apply a new class if overflowed on top;\n    // 2) apply a new rule if overflowed on the left\n    if (stylesheet.cssRules.length > 0) {\n      stylesheet.deleteRule(0);\n    }\n    if (menuOffset.x < 0) {\n      menuOffset.x = 0;\n      stylesheet.insertRule('.pen-menu:after {left: ' + left + 'px;}', 0);\n    } else {\n      stylesheet.insertRule('.pen-menu:after {left: 50%; }', 0);\n    }\n    if (menuOffset.y < 0) {\n      menu.classList.add('pen-menu-below');\n      menuOffset.y = offset.top + offset.height + menuPadding;\n    } else {\n      menu.classList.remove('pen-menu-below');\n    }\n\n    menu.style.top = menuOffset.y + 'px';\n    menu.style.left = menuOffset.x + 'px';\n    return this;\n  };\n\n  Pen.prototype.stay = function(config) {\n    var ctx = this;\n    if (!window.onbeforeunload) {\n      window.onbeforeunload = function() {\n        if (!ctx._isDestroyed) return config.stayMsg;\n      };\n    }\n  };\n\n  Pen.prototype.destroy = function(isAJoke) {\n    var destroy = isAJoke ? false : true\n      , attr = isAJoke ? 'setAttribute' : 'removeAttribute';\n\n    if (!isAJoke) {\n      removeAllListeners(this);\n      try {\n        selection.removeAllRanges();\n        if (this._menu) this._menu.parentNode.removeChild(this._menu);\n      } catch (e) {/* IE throws error sometimes*/}\n    } else {\n      initToolbar(this);\n      initEvents(this);\n    }\n    this._isDestroyed = destroy;\n    this.config.editor[attr]('contenteditable', '');\n\n    return this;\n  };\n\n  Pen.prototype.rebuild = function() {\n    return this.destroy('it\\'s a joke');\n  };\n\n  // a fallback for old browers\n  root.Pen = function(config) {\n    if (!config) return utils.log('can\\'t find config', true);\n\n    var defaults = utils.merge(config)\n      , klass = defaults.editor.getAttribute('class');\n\n    klass = klass ? klass.replace(/\\bpen\\b/g, '') + ' pen-textarea ' + defaults.class : 'pen pen-textarea';\n    defaults.editor.setAttribute('class', klass);\n    defaults.editor.innerHTML = defaults.textarea;\n    return defaults.editor;\n  };\n  Pen.prototype.toMd = function() {\n    var html = this.getContent();\n    var turndownService = new TurndownService({\n      codeBlockStyle: 'fenced',\n      headingStyle: 'atx',\n    });\n    return turndownService.turndown(html);\n  };\n  // make it accessible\n  if (doc.getSelection) {\n    selection = doc.getSelection();\n    root.Pen = Pen;\n  }\n\n}(window, document));\n"]}